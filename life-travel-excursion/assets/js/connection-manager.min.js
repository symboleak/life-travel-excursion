!function(e){"use strict";var t={config:{slowConnectionThreshold:1e3,checkInterval:3e4,imageQualityLevels:{high:{maxWidth:1920,quality:80},medium:{maxWidth:1200,quality:70},low:{maxWidth:800,quality:60},ultraLow:{maxWidth:400,quality:50}},offlineMode:{enabled:!0,cacheDuration:7}},init:function(){this.connectionStatus={online:navigator.onLine,speed:"unknown",lastChecked:Date.now()},this.initUI(),this.setupConnectionEvents(),this.checkConnectionSpeed(),this.setupMediaHandling(),this.setupMobileAdaptability()},initUI:function(){e("body").append('<div class="connection-status">Vérification...</div>'),this.$statusElement=e(".connection-status"),e(".site-main").prepend('<div class="offline-message">Vous êtes actuellement en mode hors ligne. Certaines fonctionnalités peuvent être limitées.</div>'),this.$offlineMessage=e(".offline-message"),navigator.onLine&&this.$offlineMessage.hide()},setupConnectionEvents:function(){var e=this;window.addEventListener("online",function(){e.connectionStatus.online=!0,e.updateConnectionUI(),e.checkConnectionSpeed()}),window.addEventListener("offline",function(){e.connectionStatus.online=!1,e.connectionStatus.speed="offline",e.updateConnectionUI()}),setInterval(function(){navigator.onLine&&e.checkConnectionSpeed()},this.config.checkInterval)},checkConnectionSpeed:function(){var e=this,t=Date.now(),n=new Image,i="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";n.onload=function(){var n=Date.now(),i=n-t;i<200?e.connectionStatus.speed="fast":i<e.config.slowConnectionThreshold?e.connectionStatus.speed="medium":e.connectionStatus.speed="slow",e.connectionStatus.lastChecked=n,e.updateConnectionUI(),e.adaptMediaToConnection()},n.onerror=function(){e.connectionStatus.online=!1,e.connectionStatus.speed="offline",e.updateConnectionUI()},this.$statusElement.text("Vérification..."),n.src=i+"?t="+Date.now()},updateConnectionUI:function(){this.$statusElement.removeClass("online offline slow"),this.connectionStatus.online?(e("body").removeClass("offline-mode"),this.$offlineMessage.hide(),"slow"===this.connectionStatus.speed?(this.$statusElement.addClass("slow").text("Connexion lente"),e("body").addClass("low-bandwidth-mode")):(this.$statusElement.addClass("online").text("En ligne"),"fast"===this.connectionStatus.speed&&e("body").removeClass("low-bandwidth-mode"))):(this.$statusElement.addClass("offline").text("Hors ligne"),e("body").addClass("offline-mode"),this.$offlineMessage.show())},adaptMediaToConnection:function(){var t=this;"slow"===this.connectionStatus.speed?(e('video:not([data-connection-managed])').each(function(){var n=e(this);n.attr("data-connection-managed","true"),n.attr("data-original-sources")||(!function(){var t=[];n.find("source").each(function(){t.push({src:e(this).attr("src"),type:e(this).attr("type")})}),n.attr("data-original-sources",JSON.stringify(t))}());if(!n.hasClass("critical-video")){var i=n.attr("poster"),s=e("<img>",{src:i||"/assets/img/backgrounds/video-placeholder.svg",alt:"Vidéo non chargée (connexion lente)",class:"video-placeholder",width:n.attr("width"),height:n.attr("height")}),o=e("<div>",{class:"video-play-button",html:'<svg viewBox="0 0 24 24" width="64" height="64"><path fill="#ffffff" d="M8 5v14l11-7z"/></svg>'}),a=e("<div>",{class:"video-container slow-connection","data-video-id":n.attr("id")}).append(s).append(o);n.after(a).hide(),o.on("click",function(){var i=a.data("video-id"),s=e("#"+i);if(s.attr("data-original-sources")){var o=JSON.parse(s.attr("data-original-sources"));s.empty(),e.each(o,function(t,n){e("<source>",{src:n.src,type:n.type}).appendTo(s)}),s.load()}s.show(),a.hide(),setTimeout(function(){s[0].play()},100)})}}),this.setImagesQuality("low"),e('link[rel="preload"]:not([data-critical="true"])').each(function(){e(this).attr("rel","prefetch")})):"medium"===this.connectionStatus.speed?this.setImagesQuality("medium"):(this.setImagesQuality("high"),e('link[rel="prefetch"][data-critical="false"]').each(function(){e(this).attr("rel","preload")}))},setImagesQuality:function(t){var n=this.config.imageQualityLevels[t];e('img[data-srcset]:not([srcset]):not(.quality-managed)').each(function(){var t=e(this);t.addClass("quality-managed");var i=t.attr("data-srcset"),s=i.split(",").filter(function(e){return parseInt(e.match(/\s(\d+)w/)[1],10)<=n.maxWidth}).join(",");t.attr("srcset",s)}),e('img[data-src]:not([src]):not(.quality-managed)').each(function(){var t=e(this);t.addClass("quality-managed");var i=t.attr("data-src");if(i.indexOf(window.location.hostname)>-1||0===i.indexOf("/")){var s=i.indexOf("?")>-1?"&":"?";i=i+s+"q="+n.quality}t.attr("data-src",i)})},setupMediaHandling:function(){if("IntersectionObserver"in window){var t={rootMargin:"200px 0px",threshold:.01},n=new IntersectionObserver(function(t,n){t.forEach(function(t){if(t.isIntersecting){var i=e(t.target);if(i.hasClass("progressive-image")&&i.attr("data-src")){var s=new Image;s.onload=function(){i.attr("src",s.src),i.addClass("loaded")},s.src=i.attr("data-src"),i.removeAttr("data-src")}else i.attr("data-src")&&(i.attr("src",i.attr("data-src")),i.removeAttr("data-src"),i.addClass("loaded"));n.unobserve(t.target)}})},t);document.querySelectorAll("img[data-src]").forEach(function(e){n.observe(e)})}else e("img[data-src]").each(function(){e(this).attr("src",e(this).attr("data-src")),e(this).removeAttr("data-src"),e(this).addClass("loaded")})},setupMobileAdaptability:function(){var t=function(){window.innerHeight>window.innerWidth?e("body").removeClass("landscape-mode").addClass("portrait-mode"):e("body").removeClass("portrait-mode").addClass("landscape-mode")};t(),window.addEventListener("orientationchange",t),window.addEventListener("resize",t),"ontouchstart"in window&&(e("body").addClass("touch-device"),e(".menu-item > a, .button, .social-link, .gallery-image a").each(function(){var t=e(this),n=t.outerWidth(),i=t.outerHeight();(n<44||i<44)&&t.css({padding:Math.max(parseInt(t.css("padding-top")||0,10),Math.ceil((44-i)/2))+"px "+Math.max(parseInt(t.css("padding-right")||0,10),Math.ceil((44-n)/2))+"px"})}))}};e(document).ready(function(){t.init()})}(jQuery);
